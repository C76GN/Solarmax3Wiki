tinymce.PluginManager.add('wikilink', function (editor) {
    // 注册wikilink格式
    editor.formatter.register('wikilink', {
        inline: 'span',
        classes: 'mce-wikilink',
        attributes: {
            'data-wikilink': '%value'
        }
    });

    // 创建按钮
    editor.ui.registry.addButton('wikilink', {
        icon: 'link',
        tooltip: '插入Wiki链接',
        onAction: function () {
            openWikiLinkDialog();
        }
    });

    // 在右键菜单中添加
    editor.ui.registry.addContextMenu('wikilink', {
        update: function (element) {
            return element.classList.contains('mce-wikilink') ? ['wikilinkedit'] : ['wikilinkinsert'];
        }
    });

    // 右键菜单项
    editor.ui.registry.addMenuItem('wikilinkinsert', {
        icon: 'link',
        text: '插入Wiki链接',
        onAction: function () {
            openWikiLinkDialog();
        }
    });

    editor.ui.registry.addMenuItem('wikilinkedit', {
        icon: 'link',
        text: '编辑Wiki链接',
        onAction: function () {
            const selectedNode = editor.selection.getNode();
            const wikilinkValue = selectedNode.getAttribute('data-wikilink');
            openWikiLinkDialog(wikilinkValue);
        }
    });

    // 处理双击事件
    editor.on('dblclick', function (e) {
        if (e.target.classList.contains('mce-wikilink')) {
            const wikilinkValue = e.target.getAttribute('data-wikilink');
            openWikiLinkDialog(wikilinkValue);
        }
    });

    // 链接对话框
    function openWikiLinkDialog(initialValue) {
        let searchTimeout = null;
        let searchResults = [];

        editor.windowManager.open({
            title: initialValue ? '编辑Wiki链接' : '插入Wiki链接',
            body: {
                type: 'panel',
                items: [
                    {
                        type: 'input',
                        name: 'query',
                        label: '搜索Wiki页面',
                        placeholder: '输入页面标题...',
                        value: initialValue || ''
                    },
                    {
                        type: 'collection',
                        name: 'results',
                        label: '搜索结果',
                        disabled: true
                    }
                ]
            },
            initialData: {
                query: initialValue || '',
                results: []
            },
            buttons: [
                {
                    type: 'cancel',
                    text: '取消'
                },
                {
                    type: 'submit',
                    text: initialValue ? '更新' : '插入',
                    primary: true
                }
            ],
            onAction: function (api, details) {
                if (details.name === 'query') {
                    const query = api.getData().query;
                    if (query.length < 2) return;

                    // 清除现有的搜索超时
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }

                    // 设置新的搜索超时，实现输入防抖
                    searchTimeout = setTimeout(function () {
                        searchWikiPages(query).then(function (results) {
                            searchResults = results;
                            api.setData({ results: results.map(r => ({ value: r.id, text: r.title })) });
                        });
                    }, 300);
                }
            },
            onChange: function (api, details) {
                if (details.name === 'results') {
                    const selectedId = details.value;
                    const selectedPage = searchResults.find(r => r.id === selectedId);
                    if (selectedPage) {
                        api.setData({ query: selectedPage.title });
                    }
                }
            },
            onSubmit: function (api) {
                const data = api.getData();
                const selectedText = editor.selection.getContent({ format: 'text' });
                const pageTitle = data.query;

                // 如果有选中的文本，将其设置为链接文本
                if (selectedText && !initialValue) {
                    editor.formatter.apply('wikilink', { value: pageTitle }, { text: selectedText });
                } else {
                    // 否则使用页面标题作为链接文本
                    editor.insertContent(`<span class="mce-wikilink" data-wikilink="${pageTitle}">${pageTitle}</span>`);
                }

                api.close();
            }
        });
    }

    // 搜索Wiki页面
    async function searchWikiPages(query) {
        try {
            const response = await fetch(`/api/wiki/search?q=${encodeURIComponent(query)}`);
            if (!response.ok) {
                throw new Error('搜索请求失败');
            }
            return await response.json();
        } catch (error) {
            console.error('搜索Wiki页面失败:', error);
            return [];
        }
    }

    // 注册 Win+K 和 Win+Alt+K 快捷键
    editor.addShortcut('meta+k', '插入链接', function () {
        editor.execCommand('mceLink');
    });

    editor.addShortcut('meta+alt+k', '插入Wiki链接', function () {
        openWikiLinkDialog();
    });

    return {
        getMetadata: function () {
            return {
                name: 'Wiki Link',
                url: 'https://your-site.com/tinymce-plugins/wikilink'
            };
        }
    };
});